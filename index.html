<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Hello World</title>

    <!-- required modeler styles -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@18.0.0/dist/assets/bpmn-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@18.0.0/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@18.0.0/dist/assets/bpmn-font/css/bpmn.css">

    <!-- modeler distro -->
    <script src="https://unpkg.com/bpmn-js@18.0.0/dist/bpmn-modeler.development.js"></script>

    <!-- token simulation extension -->
    <!-- <script src="https://unpkg.com/bpmn-js-token-simulation/dist/bpmn-js-token-simulation.umd.js"></script> -->
    <script src="https://unpkg.com/browse/@yape/plugin-bpmn-js-token-simulator@1.2.0/dist/index.js"></script>
    
    <!-- needed for this example only -->
    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>

    <!-- custom styles -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="content" style="display: flex; height: 100vh;">
        <div id="canvas"></div>
        <div id="detail-panel">
            <h3 id="fault-name">Error/Fault Type </h3>
            <div id="fault-explanation">
                Here comes the explanation, so you can better understand what is wrong.
            </div>
            <button id="error-simulation-button">
                error simulation
            </button>
            <h4 id="header-quick-fix">
                Quick-Fix
            </h4>
            <div id="explanation-quick-fix">
                This is what we think you should do to fix it.
                Change the Gateway. Or change the task in place.
            </div>
            <button id="quick-fix-button"> Quick-Fix</button>
        </div>
    </div>
    

    <button id="save-button">print to console</button>
    <button id="soundness-check">check soundness</button>

    <script type="module">
        var diagramUrl = 'example/arzttermin-faulty.bpmn';//'https://cdn.statically.io/gh/bpmn-io/bpmn-js-examples/dfceecba/starter/diagram.bpmn';

        console.log('TokenSimulationModule:', window.TokenSimulationModule);

        import * as TokenSimulation from 'https://cdn.jsdelivr.net/npm/bpmn-js-token-simulation@0.36.3/lib/index.min.js';
        window.TokenSimulationModule = TokenSimulation.default || TokenSimulation;
        console.log('Loaded:', window.TokenSimulationModule); // Should log the module

        // modeler instance and necessary configs for token simulation 
        window.bpmnModeler = new BpmnJS({
            container: '#canvas',
            keyboard: {
                bindTo: window
            },
            additionalModules: [
                TokenSimulationModule
            ]
        });

        window.bpmnViewer = new BpmnJs({
        container: '#canvas',
        additionalModules: [
            TokenSimulationModule
        ]
        });

        /**
         * Save diagram contents and print them to the console.
         */
        async function exportDiagram() {

            try {

                var result = await bpmnModeler.saveXML({ format: true });

                alert('Diagram exported. Check the developer tools!');

                console.log('DIAGRAM', result.xml);
            } catch (err) {

                console.error('could not save BPMN 2.0 diagram', err);
            }
        }

        /**
         * Open diagram in our modeler instance.
         *
         * @param {String} bpmnXML diagram to display
         */
        async function openDiagram(bpmnXML) {

            // import diagram
            try {

                await bpmnModeler.importXML(bpmnXML);

                // access modeler components
                var canvas = bpmnModeler.get('canvas');
                var overlays = bpmnModeler.get('overlays');


                // zoom to fit full viewport
                canvas.zoom('fit-viewport');

                // attach an overlay to a node
                overlays.add('SCAN_OK', 'note', {
                    position: {
                        bottom: 0,
                        right: 0
                    },
                    html: '<div class="diagram-note">Mixed up the labels?</div>'
                });

                // add marker
                canvas.addMarker('SCAN_OK', 'needs-discussion');
            } catch (err) {

                console.error('could not import BPMN 2.0 diagram', err);
            }
        }


        // load external diagram file via AJAX and open it
        $.get(diagramUrl, openDiagram, 'text');

        // wire save button
        $('#save-button').click(exportDiagram);
    </script>
    <script type="module">
        import { startSubscription } from "./js/visualization/visualization.js";

        // wire soundness check button
        $('#soundness-check').click(soundnessCheck);

        function soundnessCheck(){
            startSubscription();
            SoundnessVerifier().check(
                LoopDecomposition().decompose(
                    SCC().findSCCs(
                        Normalizer.normalize(
                            analyze()
                        )
                    )
                )
            );
        }

    </script>

    <!-- token simulation set-up -->
    <!-- <script>
        window.modeler = new BpmnJs({
            container: '#canvas',
            additionalModules: [
                TokenSimulationModule
            ]
        });

        window.viewer = new BpmnJs({
        container: '#canvas',
        additionalModules: [
            TokenSimulationModule
        ]
        });
    </script> -->
      
</body>
<script src="js/settools.js" async></script>
<script src="js/export.js" async></script>
<script src="js/model.js" async></script>
<script src="js/faultbus.js" async></script>
<script src="js/normalize.js" async></script>
<script src="js/scc.js" async></script>
<script src="js/loopdecomp.js" async></script>
<script src="js/soundness.js" async></script>
<script type="module" src="js/visualization/visualization.js" async></script>
<script type="module" src="js/visualization/createMarker.js" async></script>
<script type="module" src="js/visualization/faultPanel.js" async></script>
<script type="module" src="js/visualization/tokenSimulator.js" async></script>
</html>
<!--
Thanks for trying out our BPMN toolkit!

This example uses the pre-built distribution of the bpmn-js modeler.
Consider rolling your own distribution to have more flexibility
regarding which features to include.

Checkout our advanced examples section to learn more:
* https://github.com/bpmn-io/bpmn-js-examples#advanced

To get a bit broader overview over how bpmn-js works,
follow our walkthrough:
* https://bpmn.io/toolkit/bpmn-js/walkthrough/

Related starters:
* https://raw.githubusercontent.com/bpmn-io/bpmn-js-examples/starter/viewer.html
-->